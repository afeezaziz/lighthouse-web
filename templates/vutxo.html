{% extends "base.html" %}

{% block content %}
<div class="mb-8">
  <h1 class="text-3xl font-bold text-white mb-2">VUTXO (Ark L2) - Tagged Taproot Asset Movements</h1>
  <p class="text-gray-300">Visualize movements of a tagged Taproot Asset across addresses and Ark nodes.</p>
</div>

<!-- Filters -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
    <div class="md:col-span-2">
      <label class="block text-sm text-gray-400 mb-1" for="assetIdInput">Asset ID</label>
      <input id="assetIdInput" type="text" placeholder="ta1qqq... (optional)" value="{{ asset_id or '' }}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="md:col-span-2">
      <label class="block text-sm text-gray-400 mb-1" for="tagInput">Tag</label>
      <input id="tagInput" type="text" placeholder="e.g. merchant, exchange, tagged" value="{{ tag or '' }}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="flex gap-3">
      <button id="applyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition duration-200">
        <i class="fas fa-filter mr-2"></i>
        Apply
      </button>
      <button id="resetBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg transition duration-200">
        <i class="fas fa-rotate mr-2"></i>
        Reset
      </button>
    </div>
  </div>
</div>

<!-- Status / Summary -->
<div id="summaryCards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-400">Asset</p>
        <p id="assetName" class="text-2xl font-bold text-white">-</p>
      </div>
      <i class="fas fa-coins text-yellow-400 text-2xl"></i>
    </div>
  </div>
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-400">Movements</p>
        <p id="movementCount" class="text-2xl font-bold text-white">0</p>
      </div>
      <i class="fas fa-exchange-alt text-purple-400 text-2xl"></i>
    </div>
  </div>
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-400">Unique Addresses</p>
        <p id="uniqueAddr" class="text-2xl font-bold text-white">0</p>
      </div>
      <i class="fas fa-address-book text-blue-400 text-2xl"></i>
    </div>
  </div>
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-400">Total Amount</p>
        <p id="totalAmount" class="text-2xl font-bold text-white">0</p>
      </div>
      <i class="fas fa-chart-line text-green-400 text-2xl"></i>
    </div>
  </div>
</div>

<!-- Visualization and Table -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
    <div class="flex items-center justify-between px-2">
      <h2 class="text-lg font-semibold text-white">Movement Graph</h2>
      <span id="vizLegend" class="text-xs text-gray-400">Node = address, Link width = amount</span>
    </div>
    <div id="graphContainer" class="mt-2">
      <svg id="movementGraph" class="w-full" style="height: 420px;"></svg>
    </div>
  </div>

  <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-white">Movements</h2>
      <span id="loadingBadge" class="hidden px-2 py-1 text-xs rounded bg-gray-700 text-gray-300">Loading...</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">From</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">To</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Via Node</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tags</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">TXID</th>
          </tr>
        </thead>
        <tbody id="movementBody" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Error notice -->
<div id="errorBox" class="hidden mt-6 bg-red-900/40 border border-red-700 text-red-200 rounded-lg p-4"></div>

<!-- D3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" integrity="sha512-zbXnQvG8mKIn2U5n24q7c4YH0oTjQ6bU6Q51GNs0mYxP5R0l3b1N9xqAzqj76KQ8YyN6i2gV6N7Wp7gqf1z3kg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  const assetIdInput = document.getElementById('assetIdInput');
  const tagInput = document.getElementById('tagInput');
  const applyBtn = document.getElementById('applyBtn');
  const resetBtn = document.getElementById('resetBtn');
  const loadingBadge = document.getElementById('loadingBadge');
  const movementBody = document.getElementById('movementBody');
  const errorBox = document.getElementById('errorBox');
  const svg = d3.select('#movementGraph');
  const width = document.getElementById('graphContainer').clientWidth;
  const height = 420;
  svg.attr('viewBox', `0 0 ${width} ${height}`);

  function formatAmount(raw, decimals) {
    if (typeof raw !== 'number') return '-';
    const p = Math.pow(10, decimals || 0);
    return (raw / p).toLocaleString(undefined, { maximumFractionDigits: decimals || 0 });
  }

  function shorten(str, head = 6, tail = 6) {
    if (!str) return '';
    return str.length > head + tail + 3 ? `${str.slice(0, head)}...${str.slice(-tail)}` : str;
  }

  function setLoading(v) {
    loadingBadge.classList.toggle('hidden', !v);
  }

  function setError(msg) {
    if (msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    } else {
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
    }
  }

  function buildGraph(data) {
    // Derive nodes from address appearances
    const addrSet = new Set();
    data.movements.forEach(m => { addrSet.add(m.from); addrSet.add(m.to); });
    const nodes = Array.from(addrSet).map(a => ({ id: a }));
    const links = data.movements.map(m => ({ source: m.from, target: m.to, value: m.amount }));

    svg.selectAll('*').remove();

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id).distance(d => 80 + Math.min(120, (1e10 / (d.value || 1)))) )
      .force('charge', d3.forceManyBody().strength(-150))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(24));

    const linkScale = d3.scaleLinear()
      .domain(d3.extent(links, d => d.value || 0))
      .range([1, 8]);

    const link = svg.append('g')
      .attr('stroke', '#7c3aed')
      .attr('stroke-opacity', 0.5)
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('stroke-width', d => linkScale(d.value || 0));

    const node = svg.append('g')
      .attr('stroke', '#111827')
      .attr('stroke-width', 1.5)
      .selectAll('circle')
      .data(nodes)
      .join('circle')
      .attr('r', 10)
      .attr('fill', '#10b981')
      .call(drag(simulation));

    const label = svg.append('g')
      .selectAll('text')
      .data(nodes)
      .join('text')
      .attr('fill', '#cbd5e1')
      .attr('font-size', 10)
      .text(d => shorten(d.id));

    node.append('title').text(d => d.id);

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);

      label
        .attr('x', d => d.x + 12)
        .attr('y', d => d.y + 4);
    });

    function drag(sim) {
      function dragstarted(event) {
        if (!event.active) sim.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }
      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }
      function dragended(event) {
        if (!event.active) sim.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
      return d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
    }
  }

  function renderTable(data) {
    movementBody.innerHTML = '';
    const dec = (data.asset && data.asset.decimals) || 0;

    data.movements.forEach(m => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-750';
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${new Date(m.time).toLocaleString()}</td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">${shorten(m.from)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">${shorten(m.to)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${formatAmount(m.amount, dec)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${m.via_node || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">${(m.tags || []).join(', ')}</td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">${m.txid}</td>
      `;
      movementBody.appendChild(tr);
    });
  }

  function updateSummary(data) {
    const dec = (data.asset && data.asset.decimals) || 0;
    document.getElementById('assetName').textContent = `${data.asset?.name || 'Unknown'} (${data.asset?.ticker || '-'})`;
    document.getElementById('movementCount').textContent = data.movements?.length || 0;
    const addrSet = new Set();
    (data.movements || []).forEach(m => { addrSet.add(m.from); addrSet.add(m.to); });
    document.getElementById('uniqueAddr').textContent = addrSet.size;
    const total = (data.movements || []).reduce((a, m) => a + (m.amount || 0), 0);
    document.getElementById('totalAmount').textContent = formatAmount(total, dec);
  }

  async function fetchMovements() {
    setError('');
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (assetIdInput.value) params.set('asset_id', assetIdInput.value);
      if (tagInput.value) params.set('tag', tagInput.value);
      const res = await fetch(`/api/v1/vutxo/movements?${params.toString()}`);
      if (!res.ok) throw new Error(`Request failed: ${res.status}`);
      const data = await res.json();

      buildGraph(data);
      renderTable(data);
      updateSummary(data);
    } catch (e) {
      console.error(e);
      setError(e.message || 'Failed to load movements');
    } finally {
      setLoading(false);
    }
  }

  applyBtn.addEventListener('click', () => fetchMovements());
  resetBtn.addEventListener('click', () => {
    assetIdInput.value = '';
    tagInput.value = '';
    fetchMovements();
  });

  // Initial load
  fetchMovements();
</script>
{% endblock %}
